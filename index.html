<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Fully Explicit Explanation of a Finite-cutoff Identity for the Twin-prime Sieve Factors</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],
                packages: {'[+]': ['ams', 'mathtools']}
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    // Calculate initial example when MathJax is ready
                    setTimeout(calculateIdentity, 1000);
                }
            }
        };
    </script>
    <style>
        body {
            font-family: 'Times', serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
            background-color: #fefefe;
            color: #333;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid #333;
            padding-bottom: 30px;
        }
        
        h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #1a1a1a;
        }
        
        .author {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .date {
            font-size: 16px;
            color: #666;
        }
        
        .interactive-section {
            background-color: #f0f8ff;
            border: 2px solid #4682b4;
            border-radius: 10px;
            padding: 25px;
            margin: 30px 0;
        }
        
        .calculator-box {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .calculator-box label {
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .calculator-box input {
            padding: 8px 12px;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px;
            margin-right: 10px;
            width: 100px;
        }
        
        .calculator-box button {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .calculator-box button:hover {
            background-color: #2980b9;
        }
        
        .results-display {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            min-height: 50px;
        }
        
        .calculation-step {
            background-color: white;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .calculation-step h4 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .verification {
            background-color: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .verification h4 {
            color: #155724;
            margin-top: 0;
        }
        
        .per-prime-work {
            background-color: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .prime-calculation {
            background-color: white;
            border: 1px solid #28a745;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .prime-calculation h5 {
            color: #155724;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: bold;
            border-bottom: 1px solid #c3e6cb;
            padding-bottom: 5px;
        }
        
        .abstract {
            background-color: #f9f9f9;
            border-left: 4px solid #2c3e50;
            padding: 20px;
            margin: 30px 0;
            font-style: italic;
        }
        
        .abstract h2 {
            margin-top: 0;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #2c3e50;
        }
        
        h2 {
            font-size: 20px;
            margin-top: 40px;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        h3 {
            font-size: 18px;
            margin-top: 30px;
            margin-bottom: 15px;
            color: #34495e;
        }
        
        .theorem {
            background-color: #e8f4f8;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
        }
        
        .theorem-title {
            font-weight: bold;
            color: #2980b9;
            margin-bottom: 15px;
        }
        
        .boxed-formula {
            background-color: #fff;
            border: 3px solid #e74c3c;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .proof-section {
            background-color: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 20px;
            margin: 25px 0;
        }
        
        .example-section {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .example-title {
            font-weight: bold;
            color: #856404;
            margin-bottom: 15px;
        }
        
        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        
        li {
            margin-bottom: 10px;
        }
        
        .math-display {
            margin: 20px 0;
            text-align: center;
        }
        
        .interpretation {
            background-color: #f0f8ff;
            border: 1px solid #87ceeb;
            border-radius: 5px;
            padding: 20px;
            margin: 25px 0;
        }
        
        .paragraph-title {
            font-weight: bold;
            color: #4682b4;
            margin-bottom: 10px;
        }
        
        .qed {
            text-align: right;
            font-weight: bold;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>A Fully Explicit Explanation of a Finite-cutoff Identity for the Twin-prime Sieve Factors</h1>
        <div class="author">Wessen Getachew</div>
        <div class="date">September 16, 2025</div>
    </div>

    <div class="interactive-section">
        <h2>Interactive Calculator</h2>
        <div class="calculator-box">
            <label for="pmax-input">Enter p_max (prime ≥ 3):</label>
            <input type="number" id="pmax-input" value="7" min="3" step="1">
            <button onclick="calculateIdentity()">Calculate Identity</button>
            
            <div id="results" class="results-display">
                <!-- Results will appear here -->
            </div>
        </div>
    </div>

    <div class="abstract">
        <h2>Abstract</h2>
        <p>This note gives a fully explicit statement, proof, and numerical examples of the finite-cutoff identity</p>
        <div class="math-display">
            \[
            \prod_{\substack{p\text{ prime}\\3\le p\le p_{\max}}}\frac{(p-1)(p-2)}{p^{2}}
            =
            \left(\prod_{\substack{p\text{ prime}\\3\le p\le p_{\max}}}\left(1-\frac{1}{(p-1)^{2}}\right)\right)
            \left(\prod_{\substack{p\text{ prime}\\3\le p\le p_{\max}}}\left(1-\frac{1}{p}\right)\right)^{3},
            \]
        </div>
        <p>with every symbol defined and with explicit arithmetic checks for small cutoffs. The document also discusses the meaning and implications of this identity for the special prime gap of size two (twin primes).</p>
    </div>

    <h2>Notation and conventions</h2>
    <ul>
        <li>Throughout this note, \(p\) denotes a <em>prime number</em>. We use \(p_{\max}\) to denote a fixed finite cutoff prime, and we assume \(p_{\max}\ge 3\).</li>
        <li>The phrase "product over primes \(3\le p\le p_{\max}\)" means the finite product taken over every prime \(p\) satisfying \(3\le p\le p_{\max}\); that is, \(p\in\{3,5,7,\dots,p_{\max}\}\).</li>
        <li>We write the ordinary multiplicative symbol \(\prod\) with explicit index conditions whenever clarity is needed.</li>
        <li>We define the following three functions of the cutoff \(p_{\max}\) (these are <em>finite</em> products):
            <div class="math-display">
                \begin{align}
                N(p_{\max}) &:= \prod_{\substack{p\ \text{prime}\\ 3\le p\le p_{\max}}} \frac{(p-1)(p-2)}{p^{2}}, \\[6pt]
                C_{2}(p_{\max}) &:= \prod_{\substack{p\ \text{prime}\\ 3\le p\le p_{\max}}}\left(1-\frac{1}{(p-1)^{2}}\right), \\[6pt]
                M_{\neq 2}(p_{\max}) &:= \prod_{\substack{p\ \text{prime}\\ 3\le p\le p_{\max}}}\left(1-\frac{1}{p}\right).
                \end{align}
            </div>
        </li>
        <li>Note explicitly: the product index \(\{3\le p\le p_{\max}\}\) starts at \(p=3\). We <em>exclude</em> \(p=2\) because the factor \(\frac{(2-2)}{2^{2}}=0\) would zero out the entire left-hand product and make the identity meaningless.</li>
    </ul>

    <h2>Exact finite identity (statement)</h2>
    <div class="theorem">
        <div class="theorem-title">Theorem (Finite prime-by-prime factorization)</div>
        <p>For every integer \(p_{\max}\ge 3\), the following identity holds exactly:</p>
        <div class="boxed-formula">
            \[
            \prod_{\substack{p\ \text{prime}\\ 3\le p\le p_{\max}}} \frac{(p-1)(p-2)}{p^{2}}
            \;=\;
            \left( \prod_{\substack{p\ \text{prime}\\ 3\le p\le p_{\max}}} \!\left(1-\frac{1}{(p-1)^{2}}\right) \right)
            \cdot
            \left( \prod_{\substack{p\ \text{prime}\\ 3\le p\le p_{\max}}} \!\left(1-\frac{1}{p}\right) \right)^{3}
            \]
        </div>
        <p>In short notation, \(N(p_{\max}) = C_{2}(p_{\max})\,[M_{\neq 2}(p_{\max})]^{3}\).</p>
    </div>

    <h2>Proof (termwise algebraic identity)</h2>
    <div class="proof-section">
        <p>We prove the theorem by showing the identity holds for each single prime factor \(p\ge 3\), and then taking the product over all such primes up to the cutoff.</p>

        <p>Fix a prime \(p\) with \(p\ge 3\). Compute two elementary algebraic expressions.</p>

        <p>First,</p>
        <div class="math-display">
            \[
            1-\frac{1}{(p-1)^{2}}
            = \frac{(p-1)^{2}-1}{(p-1)^{2}}
            = \frac{p^{2}-2p}{(p-1)^{2}}
            = \frac{p(p-2)}{(p-1)^{2}}.
            \]
        </div>

        <p>Second,</p>
        <div class="math-display">
            \[
            1-\frac{1}{p}=\frac{p-1}{p}.
            \]
        </div>
        <p>Cubing the second expression gives</p>
        <div class="math-display">
            \[
            \left(1-\frac{1}{p}\right)^{3}=\frac{(p-1)^{3}}{p^{3}}.
            \]
        </div>

        <p>Now multiply the two pieces together:</p>
        <div class="math-display">
            \begin{align}
            \left(1-\frac{1}{(p-1)^{2}}\right)\left(1-\frac{1}{p}\right)^{3}
            &= \frac{p(p-2)}{(p-1)^{2}}\cdot\frac{(p-1)^{3}}{p^{3}} \\[6pt]
            &= \frac{p(p-2)(p-1)^{3}}{(p-1)^{2}p^{3}} \\
            &= \frac{(p-1)(p-2)}{p^{2}}.
            \end{align}
        </div>

        <p>But the right-hand side of the last displayed equality is exactly the single-prime factor that appears in the definition of \(N(p_{\max})\), namely \(\frac{(p-1)(p-2)}{p^{2}}\). Therefore the identity holds for each prime factor \(p\ge 3\). Taking the product of these equalities over all primes \(p\) with \(3\le p\le p_{\max}\) yields the claimed finite identity</p>
        <div class="math-display">
            \[
            N(p_{\max}) = C_{2}(p_{\max})\,[M_{\neq 2}(p_{\max})]^{3}.
            \]
        </div>
        <p>This completes the proof.</p>
        <div class="qed">∎</div>
    </div>

    <h2>Alternative display with the multiplicative constant \(\frac{1}{4}\)</h2>
    <p>Some presentations display the same algebra in the (equivalently true) form</p>
    <div class="math-display">
        \[
        \frac{N(p_{\max})}{\frac{1}{4}\,C_{2}(p_{\max})\,[M_{\neq 2}(p_{\max})]^{3}}=4,
        \]
    </div>
    <p>which follows immediately because \(C_{2}(p_{\max})[M_{\neq 2}(p_{\max})]^{3}=N(p_{\max})\) and hence the denominator equals \(\frac{1}{4}N(p_{\max})\), so the whole fraction equals \(N(p_{\max})/(\frac14 N(p_{\max}))=4\). Both formulations express the same algebraic fact: the per-prime factors match exactly.</p>

    <h2>Explicit numerical examples (step-by-step arithmetic)</h2>
    <p>We display the arithmetic with no omissions for the small cutoffs \(p_{\max}=3\), \(p_{\max}=5\), and \(p_{\max}=13\). Each example lists the left-hand product factor by factor, the right-hand product factor by factor, and the final equality. We simplify rational fractions fully where convenient and show decimal approximations for sanity checks.</p>

    <h3>Example: \(p_{\max}=3\)</h3>
    <div class="example-section">
        <div class="example-title">Primes used: \(\{3\}\).</div>
        
        <p><strong>Left-hand product:</strong></p>
        <div class="math-display">
            \[
            N(3) = \frac{(3-1)(3-2)}{3^{2}} = \frac{2\cdot 1}{9} = \frac{2}{9}.
            \]
        </div>

        <p><strong>Right-hand pieces:</strong></p>
        <div class="math-display">
            \[
            C_{2}(3)= 1-\frac{1}{(3-1)^{2}}=1-\frac{1}{4}=\frac{3}{4},
            \qquad
            M_{\neq 2}(3)=1-\frac{1}{3}=\frac{2}{3}.
            \]
        </div>
        <p>Then</p>
        <div class="math-display">
            \[
            C_{2}(3)\,[M_{\neq 2}(3)]^{3}
            = \frac{3}{4}\cdot\left(\frac{2}{3}\right)^{3}
            = \frac{3}{4}\cdot\frac{8}{27}
            = \frac{24}{108}
            = \frac{2}{9}.
            \]
        </div>
        <p>Hence \(N(3)=C_{2}(3)[M_{\neq2}(3)]^{3}=\frac{2}{9}\). Decimal check: \(2/9\approx 0.222222\).</p>
    </div>

    <h3>Example: \(p_{\max}=5\)</h3>
    <div class="example-section">
        <div class="example-title">Primes used: \(\{3,5\}\).</div>
        
        <p><strong>Left-hand product:</strong></p>
        <div class="math-display">
            \begin{align}
            N(5) &= \frac{(3-1)(3-2)}{3^{2}}\cdot\frac{(5-1)(5-2)}{5^{2}} \\
            &= \frac{2}{9}\cdot\frac{12}{25} \\
            &= \frac{24}{225} = \frac{8}{75}.
            \end{align}
        </div>

        <p><strong>Right-hand pieces:</strong></p>
        <div class="math-display">
            \begin{align}
            C_{2}(5) &= \left(1-\frac{1}{(3-1)^{2}}\right)\left(1-\frac{1}{(5-1)^{2}}\right)
            = \frac{3}{4}\cdot\frac{15}{16}=\frac{45}{64},\\[6pt]
            M_{\neq 2}(5) &= \left(1-\frac{1}{3}\right)\left(1-\frac{1}{5}\right)=\frac{2}{3}\cdot\frac{4}{5}=\frac{8}{15}.
            \end{align}
        </div>
        <p>Then</p>
        <div class="math-display">
            \[
            C_{2}(5)\,[M_{\neq 2}(5)]^{3}
            = \frac{45}{64}\cdot\left(\frac{8}{15}\right)^{3}
            = \frac{45}{64}\cdot\frac{512}{3375}.
            \]
        </div>
        <p>Simplify step by step:</p>
        <div class="math-display">
            \[
            \frac{45}{64}\cdot\frac{512}{3375}
            = \frac{45\cdot 512}{64\cdot 3375}
            = \frac{45\cdot 8}{3375}
            = \frac{360}{3375}
            = \frac{8}{75}.
            \]
        </div>
        <p>Hence \(N(5)=C_{2}(5)[M_{\neq 2}(5)]^{3}=\frac{8}{75}\). Decimal check: \(8/75\approx 0.106666\).</p>
    </div>

    <h3>Example: \(p_{\max}=13\)</h3>
    <div class="example-section">
        <div class="example-title">Primes used: \(\{3,5,7,11,13\}\).</div>
        
        <p><strong>Left-hand product</strong> (compute factor-by-factor):</p>
        <div class="math-display">
            \begin{align}
            N(13) &=
            \frac{(3-1)(3-2)}{3^{2}}
            \cdot
            \frac{(5-1)(5-2)}{5^{2}}
            \cdot
            \frac{(7-1)(7-2)}{7^{2}}
            \cdot
            \frac{(11-1)(11-2)}{11^{2}}
            \cdot
            \frac{(13-1)(13-2)}{13^{2}} \\
            &=
            \frac{2}{9}\cdot\frac{12}{25}\cdot\frac{30}{49}\cdot\frac{90}{121}\cdot\frac{132}{169}.
            \end{align}
        </div>
        <p>Multiplying numerators and denominators gives</p>
        <div class="math-display">
            \[
            N(13)=\frac{2\cdot 12\cdot 30\cdot 90\cdot 132}{9\cdot 25\cdot 49\cdot 121\cdot 169}
            =\frac{8\,553\,600}{225\,450\,225}.
            \]
        </div>
        <p>A convenient simplified representation (divide numerator and denominator by \(11\)) is</p>
        <div class="math-display">
            \[
            N(13)=\frac{3\,456}{91\,091}
            \approx 0.0379400819.
            \]
        </div>

        <p><strong>Right-hand pieces:</strong></p>
        <div class="math-display">
            \begin{align}
            C_{2}(13) &= \prod_{p\in\{3,5,7,11,13\}}\left(1-\frac{1}{(p-1)^{2}}\right)
            = \frac{11011}{16384}
            \approx 0.6720581055,\\[6pt]
            M_{\neq 2}(13) &= \prod_{p\in\{3,5,7,11,13\}}\left(1-\frac{1}{p}\right)
            = \frac{384}{1001}
            \approx 0.3836163836.
            \end{align}
        </div>
        <p>Compute the cube and the product:</p>
        <div class="math-display">
            \[
            [M_{\neq 2}(13)]^{3} = \left(\frac{384}{1001}\right)^{3},
            \qquad
            C_{2}(13)\,[M_{\neq 2}(13)]^{3} \;=\; N(13).
            \]
        </div>
        <p>The equality \(C_{2}(13)[M_{\neq 2}(13)]^{3}=N(13)\) holds exactly by the per-prime algebra proved above; the displayed rational values numerically match the left side and the right side to the shown decimal precision.</p>
    </div>

    <h2>Remarks and clarifications</h2>
    <ol>
        <li><strong>Why start at the prime \(3\) and not at \(2\).</strong> The left-hand factor for \(p=2\) would be \(\frac{(2-1)(2-2)}{2^{2}}=0\). Including \(p=2\) in the product would collapse \(N(p_{\max})\) to zero and destroy the identity. The algebraic identity that produces the factorization is valid prime-by-prime only for primes \(p\ge 3\); therefore the convention is to start all products at \(p=3\).</li>
        <li><strong>This is a prime-indexed identity.</strong> The index set must be the primes; attempting to replace the prime index by "all integers" or by a set that includes composite numbers will not preserve the algebra, because the factor \(\frac{(n-1)(n-2)}{n^{2}}\) for a composite \(n\) does not decompose in the same form and the sieve interpretation breaks down.</li>
        <li><strong>The \(\frac{1}{4}\) and the number \(4\) in some displays.</strong> If one writes the denominator as \(\frac{1}{4}\,C_{2}(p_{\max})[M_{\neq 2}(p_{\max})]^{3}\), then the quotient equals \(4\) because that denominator equals \(\frac{1}{4}N(p_{\max})\). The appearance of \(\frac{1}{4}\) is a harmless normalization: it does not change the substance of the identity.</li>
    </ol>

    <h2>Interpretation and implications for the twin prime problem</h2>
    <div class="interpretation">
        <div class="paragraph-title">What the identity means in words.</div>
        <p>The left-hand product \(N(p_{\max})\) is a finite sieve factor that quantifies how many integers remain after removing residues forbidden by divisibility conditions at primes up to \(p_{\max}\) for the twin prime pattern \((n,n+2)\). The right-hand side decomposes the same finite sieve factor into two conceptually distinct parts:</p>
        <ul>
            <li>\(M_{\neq 2}(p_{\max})\), which is a truncated Mertens-type product measuring <em>ordinary prime scarcity</em> (the density effect of primes), and</li>
            <li>\(C_{2}(p_{\max})\), which is the truncated Hardy–Littlewood twin-prime residue correction that accounts specifically for the residues excluded by the twin configuration.</li>
        </ul>
        <p>The identity says, exactly and at each finite cutoff, that the twin-prime sieve factor equals the cube of the ordinary prime-density factor multiplied by the twin-specific correction.</p>

        <div class="paragraph-title">Why the cube appears.</div>
        <p>Informally, twin primes require two numbers to be prime simultaneously (the number \(n\) and the number \(n+2\)). The appearance of the cube \([M_{\neq 2}(p_{\max})]^{3}\) can be interpreted as three overlapping density factors: two corresponding to prime-likeness of the separate entries \(n\) and \(n+2\), and a third that accounts for the mutual compatibility of their residues. The precise per-prime algebra above explains how those three factors combine multiplicatively into the simple polynomial factor \(\frac{(p-1)(p-2)}{p^{2}}\).</p>

        <div class="paragraph-title">What this does not do.</div>
        <p>This algebraic identity is an exact structural decomposition of finite cutoff sieve factors. It does not by itself prove that there are infinitely many twin primes. It clarifies the finite structure and shows compatibility between Hardy–Littlewood style factors and the concrete per-prime sieve factors that occur in modular/computational sieves.</p>
    </div>

    <h2>Connections to a modular sieve perspective</h2>
    <p>If one constructs a modular sieve that retains residue classes modulo a base modulus \(M\) (for example \(M=30\cdot 2^{n}\) as in your modular sieve program), then the finite products above are the natural multiplicative densities that appear when counting admissible residue classes modulo primes dividing \(M\) and when lifting to larger moduli. The exact finite factorization gives a direct algebraic link between the classical truncated constants used in the Hardy–Littlewood heuristic and the residue-counting factors that arise in explicit modular sieves.</p>

    <h2>Concluding statement</h2>
    <p>All steps of the algebra are elementary and exact. When the products are taken over primes \(p\) with \(3\le p\le p_{\max}\) the factor-by-factor algebraic identity</p>
    <div class="math-display">
        \[
        \left(1-\frac{1}{(p-1)^{2}}\right)\left(1-\frac{1}{p}\right)^{3}=\frac{(p-1)(p-2)}{p^{2}}
        \]
    </div>
    <p>immediately implies the global finite identity</p>
    <div class="math-display">
        \[
        \prod_{\substack{p\ \text{prime}\\ 3\le p\le p_{\max}}} \frac{(p-1)(p-2)}{p^{2}}
        =
        \left( \prod_{\substack{p\ \text{prime}\\ 3\le p\le p_{\max}}} \left(1-\frac{1}{(p-1)^{2}}\right) \right)
        \left( \prod_{\substack{p\ \text{prime}\\ 3\le p\le p_{\max}}} \left(1-\frac{1}{p}\right) \right)^{3}.
        \]
    </div>
    <p>This equality is exact for every finite cutoff \(p_{\max}\ge 3\), and the document above shows the algebra and numerical checks with no abbreviations.</p>

    <script>
        // Helper function to check if a number is prime
        function isPrime(n) {
            if (n < 2) return false;
            if (n === 2) return true;
            if (n % 2 === 0) return false;
            for (let i = 3; i * i <= n; i += 2) {
                if (n % i === 0) return false;
            }
            return true;
        }
        
        // Get all primes up to n
        function getPrimesUpTo(n) {
            const primes = [];
            for (let i = 3; i <= n; i++) {
                if (isPrime(i)) primes.push(i);
            }
            return primes;
        }
        
        // Calculate greatest common divisor
        function gcd(a, b) {
            while (b !== 0) {
                let temp = b;
                b = a % b;
                a = temp;
            }
            return a;
        }
        
        // Simplify a fraction
        function simplifyFraction(num, den) {
            const g = gcd(Math.abs(num), Math.abs(den));
            return [num / g, den / g];
        }
        
        function calculateIdentity() {
            const pmax = parseInt(document.getElementById('pmax-input').value);
            
            if (!isPrime(pmax) || pmax < 3) {
                document.getElementById('results').innerHTML = '<p style="color: red;">Please enter a prime number ≥ 3</p>';
                return;
            }
            
            const primes = getPrimesUpTo(pmax);
            let results = `<h3>Calculation for p_max = ${pmax}</h3>`;
            results += `<p><strong>Primes used:</strong> {${primes.join(', ')}}</p>`;
            
            // Show per-prime factorization first
            results += `<div class="per-prime-work"><h4>Per-Prime Identity Verification</h4>`;
            results += `<p>For each prime p ≥ 3, we verify: \\(\\left(1-\\frac{1}{(p-1)^{2}}\\right)\\left(1-\\frac{1}{p}\\right)^{3} = \\frac{(p-1)(p-2)}{p^{2}}\\)</p>`;
            
            for (let p of primes) {
                results += `<div class="prime-calculation">`;
                results += `<h5>Prime p = ${p}:</h5>`;
                
                // Left side calculation
                const term1_num = (p-1)*(p-1) - 1;
                const term1_den = (p-1)*(p-1);
                const [t1_simp_num, t1_simp_den] = simplifyFraction(term1_num, term1_den);
                
                const term2_num = p - 1;
                const term2_den = p;
                const [t2_simp_num, t2_simp_den] = simplifyFraction(term2_num, term2_den);
                
                const term2_cubed_num = t2_simp_num ** 3;
                const term2_cubed_den = t2_simp_den ** 3;
                
                const left_product_num = t1_simp_num * term2_cubed_num;
                const left_product_den = t1_simp_den * term2_cubed_den;
                const [left_final_num, left_final_den] = simplifyFraction(left_product_num, left_product_den);
                
                // Right side calculation
                const right_num = (p-1) * (p-2);
                const right_den = p * p;
                const [right_final_num, right_final_den] = simplifyFraction(right_num, right_den);
                
                results += `<p>\\[1-\\frac{1}{(${p}-1)^{2}} = 1-\\frac{1}{${(p-1)*(p-1)}} = \\frac{${(p-1)*(p-1)}-1}{${(p-1)*(p-1)}} = \\frac{${term1_num}}{${term1_den}}`;
                if (t1_simp_num !== term1_num || t1_simp_den !== term1_den) {
                    results += ` = \\frac{${t1_simp_num}}{${t1_simp_den}}`;
                }
                results += `\\]</p>`;
                
                results += `<p>\\[1-\\frac{1}{${p}} = \\frac{${p}-1}{${p}} = \\frac{${term2_num}}{${term2_den}}`;
                if (t2_simp_num !== term2_num || t2_simp_den !== term2_den) {
                    results += ` = \\frac{${t2_simp_num}}{${t2_simp_den}}`;
                }
                results += `\\]</p>`;
                
                results += `<p>\\[\\left(1-\\frac{1}{${p}}\\right)^{3} = \\left(\\frac{${t2_simp_num}}{${t2_simp_den}}\\right)^{3} = \\frac{${term2_cubed_num}}{${term2_cubed_den}}\\]</p>`;
                
                results += `<p><strong>Left side product:</strong></p>`;
                results += `<p>\\[\\frac{${t1_simp_num}}{${t1_simp_den}} \\cdot \\frac{${term2_cubed_num}}{${term2_cubed_den}} = \\frac{${left_product_num}}{${left_product_den}}`;
                if (left_final_num !== left_product_num || left_final_den !== left_product_den) {
                    results += ` = \\frac{${left_final_num}}{${left_final_den}}`;
                }
                results += `\\]</p>`;
                
                results += `<p><strong>Right side:</strong></p>`;
                results += `<p>\\[\\frac{(${p}-1)(${p}-2)}{${p}^{2}} = \\frac{${right_num}}{${right_den}}`;
                if (right_final_num !== right_num || right_final_den !== right_den) {
                    results += ` = \\frac{${right_final_num}}{${right_final_den}}`;
                }
                results += `\\]</p>`;
                
                const matches = (left_final_num === right_final_num && left_final_den === right_final_den);
                results += `<p><strong>Verification:</strong> <span style="color: ${matches ? 'green' : 'red'}">`;
                results += `${matches ? '✓ Identity holds!' : '✗ Identity fails!'}`;
                results += `</span></p>`;
                results += `</div>`;
            }
            results += `</div>`;
            
            // Calculate N(p_max) - left side
            let N_num = 1, N_den = 1;
            let leftFactors = [];
            
            for (let p of primes) {
                const factor_num = (p - 1) * (p - 2);
                const factor_den = p * p;
                leftFactors.push(`\\frac{${factor_num}}{${factor_den}}`);
                N_num *= factor_num;
                N_den *= factor_den;
            }
            
            const [N_simplified_num, N_simplified_den] = simplifyFraction(N_num, N_den);
            
            // Calculate C_2(p_max)
            let C2_num = 1, C2_den = 1;
            let c2Factors = [];
            let c2FactorsExpanded = [];
            
            for (let p of primes) {
                const factor_num = (p - 1) * (p - 1) - 1;
                const factor_den = (p - 1) * (p - 1);
                c2Factors.push(`\\left(1-\\frac{1}{${(p-1)*(p-1)}}\\right)`);
                c2FactorsExpanded.push(`\\frac{${factor_num}}{${factor_den}}`);
                C2_num *= factor_num;
                C2_den *= factor_den;
            }
            
            const [C2_simplified_num, C2_simplified_den] = simplifyFraction(C2_num, C2_den);
            
            // Calculate M_≠2(p_max)
            let M_num = 1, M_den = 1;
            let mFactors = [];
            let mFactorsExpanded = [];
            
            for (let p of primes) {
                const factor_num = p - 1;
                const factor_den = p;
                mFactors.push(`\\left(1-\\frac{1}{${p}}\\right)`);
                mFactorsExpanded.push(`\\frac{${factor_num}}{${factor_den}}`);
                M_num *= factor_num;
                M_den *= factor_den;
            }
            
            const [M_simplified_num, M_simplified_den] = simplifyFraction(M_num, M_den);
            
            // Calculate M^3
            const M3_num = M_simplified_num ** 3;
            const M3_den = M_simplified_den ** 3;
            
            // Calculate C_2 * M^3
            const right_num = C2_simplified_num * M3_num;
            const right_den = C2_simplified_den * M3_den;
            const [right_simplified_num, right_simplified_den] = simplifyFraction(right_num, right_den);
            
            results += `
                <div class="calculation-step">
                    <h4>Left-hand side: N(${pmax})</h4>
                    <p>\\[N(${pmax}) = ${leftFactors.join(' \\cdot ')}\\]</p>
                    <p>\\[= \\frac{${N_num}}{${N_den}} = \\frac{${N_simplified_num}}{${N_simplified_den}}\\]</p>
                    <p><strong>Decimal:</strong> ${(N_simplified_num / N_simplified_den).toFixed(10)}</p>
                </div>
                
                <div class="calculation-step">
                    <h4>Right-hand side components:</h4>
                    <p><strong>C₂ term:</strong></p>
                    <p>\\[C_2(${pmax}) = ${c2Factors.join(' \\cdot ')}\\]</p>
                    <p>\\[= ${c2FactorsExpanded.join(' \\cdot ')} = \\frac{${C2_num}}{${C2_den}} = \\frac{${C2_simplified_num}}{${C2_simplified_den}}\\]</p>
                    
                    <p><strong>M≠2 term:</strong></p>
                    <p>\\[M_{\\neq 2}(${pmax}) = ${mFactors.join(' \\cdot ')}\\]</p>
                    <p>\\[= ${mFactorsExpanded.join(' \\cdot ')} = \\frac{${M_num}}{${M_den}} = \\frac{${M_simplified_num}}{${M_simplified_den}}\\]</p>
                    
                    <p><strong>Cubed term:</strong></p>
                    <p>\\[[M_{\\neq 2}(${pmax})]^3 = \\left(\\frac{${M_simplified_num}}{${M_simplified_den}}\\right)^3 = \\frac{${M3_num}}{${M3_den}}\\]</p>
                </div>
                
                <div class="calculation-step">
                    <h4>Right-hand side product:</h4>
                    <p>\\[C_2(${pmax}) \\cdot [M_{\\neq 2}(${pmax})]^3 = \\frac{${C2_simplified_num}}{${C2_simplified_den}} \\cdot \\frac{${M3_num}}{${M3_den}}\\]</p>
                    <p>\\[= \\frac{${C2_simplified_num} \\cdot ${M3_num}}{${C2_simplified_den} \\cdot ${M3_den}} = \\frac{${right_num}}{${right_den}} = \\frac{${right_simplified_num}}{${right_simplified_den}}\\]</p>
                    <p><strong>Decimal:</strong> ${(right_simplified_num / right_simplified_den).toFixed(10)}</p>
                </div>
                
                <div class="verification">
                    <h4>Final Verification:</h4>
                    <p><strong>Left side:</strong> \\(N(${pmax}) = \\frac{${N_simplified_num}}{${N_simplified_den}}\\)</p>
                    <p><strong>Right side:</strong> \\(C_2(${pmax}) \\cdot [M_{\\neq 2}(${pmax})]^3 = \\frac{${right_simplified_num}}{${right_simplified_den}}\\)</p>
                    <p><strong>Identity holds?</strong> <span style="color: ${N_simplified_num === right_simplified_num && N_simplified_den === right_simplified_den ? 'green' : 'red'}; font-size: 18px; font-weight: bold;">
                        ${N_simplified_num === right_simplified_num && N_simplified_den === right_simplified_den ? '✓ YES' : '✗ NO'}
                    </span></p>
                </div>
            `;
            
            document.getElementById('results').innerHTML = results;
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([document.getElementById('results')]);
            }
        }
    </script>
</body>
</html>
