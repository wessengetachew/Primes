<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twin-Prime Sieve Identity Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .main-identity {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 3px solid #667eea;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .main-identity::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }

        .identity-content {
            position: relative;
            z-index: 1;
        }

        .math-display {
            font-size: 1.4em;
            margin: 20px 0;
            color: #2c3e50;
            font-weight: 500;
        }

        .tabs {
            display: flex;
            background: #34495e;
            border-radius: 10px;
            margin: 30px 0;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #34495e;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .tab:hover {
            background: #4a6741;
        }

        .tab.active {
            background: #667eea;
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            padding: 30px;
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .calculator {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .input-group {
            margin: 15px 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .result {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .error {
            background: linear-gradient(135deg, #f8d7da, #f1aeb5);
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .example {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .proof-step {
            background: linear-gradient(135deg, #e8f4fd, #d1ecf1);
            border: 2px solid #17a2b8;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
        }

        .proof-step::before {
            content: "Step " counter(step);
            counter-increment: step;
            position: absolute;
            top: -10px;
            left: 20px;
            background: #17a2b8;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .proof-container {
            counter-reset: step;
        }

        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
        }

        .fraction .numerator {
            display: block;
            border-bottom: 1px solid #000;
            padding-bottom: 2px;
        }

        .fraction .denominator {
            display: block;
            padding-top: 2px;
        }

        .interactive-demo {
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        }

        .slider-container {
            margin: 20px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .math-display {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Twin-Prime Sieve Identity Explorer</h1>
        <p class="subtitle">Interactive exploration of finite-cutoff identities for twin-prime sieve factors</p>

        <div class="main-identity">
            <div class="identity-content">
                <h2>The Main Identity</h2>
                <div class="math-display">
                    ∏<sub>p prime, 3≤p≤p<sub>max</sub></sub> <span class="fraction"><span class="numerator">(p-1)(p-2)</span><span class="denominator">p²</span></span>
                    = 
                    [∏<sub>p prime, 3≤p≤p<sub>max</sub></sub> (1 - <span class="fraction"><span class="numerator">1</span><span class="denominator">(p-1)²</span></span>)]
                    · 
                    [∏<sub>p prime, 3≤p≤p<sub>max</sub></sub> (1 - <span class="fraction"><span class="numerator">1</span><span class="denominator">p</span></span>)]³
                </div>
                <p><strong>In notation:</strong> N(p<sub>max</sub>) = C₂(p<sub>max</sub>) · [M<sub>≠2</sub>(p<sub>max</sub>)]³</p>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('calculator')">Interactive Calculator</button>
            <button class="tab" onclick="showTab('proof')">Step-by-Step Proof</button>
            <button class="tab" onclick="showTab('examples')">Numerical Examples</button>
            <button class="tab" onclick="showTab('visualization')">Visualizations</button>
            <button class="tab" onclick="showTab('theory')">Theory & Interpretation</button>
        </div>

        <div id="calculator" class="tab-content active">
            <h3>Interactive Identity Calculator</h3>
            <div class="calculator">
                <div class="input-group">
                    <label for="pmaxInput">Maximum Prime (p<sub>max</sub>):</label>
                    <input type="number" id="pmaxInput" min="3" max="100" value="13" onchange="calculateIdentity()">
                </div>
                <button class="btn" onclick="calculateIdentity()">Calculate Identity</button>
                <button class="btn" onclick="showAllSteps()">Show All Steps</button>
            </div>
            
            <div id="calculationResult"></div>
            
            <div class="interactive-demo">
                <h4>Prime-by-Prime Builder</h4>
                <p>Add primes one by one to see how the identity builds up:</p>
                <div id="primeBuilder"></div>
                <button class="btn" onclick="resetBuilder()">Reset</button>
            </div>
        </div>

        <div id="proof" class="tab-content">
            <h3>Interactive Proof</h3>
            <div class="proof-container">
                <div class="proof-step">
                    <h4>Single Prime Factor Analysis</h4>
                    <p>For any prime p ≥ 3, we need to show:</p>
                    <div class="math-display">
                        (1 - <span class="fraction"><span class="numerator">1</span><span class="denominator">(p-1)²</span></span>) · (1 - <span class="fraction"><span class="numerator">1</span><span class="denominator">p</span></span>)³ = <span class="fraction"><span class="numerator">(p-1)(p-2)</span><span class="denominator">p²</span></span>
                    </div>
                    <div class="calculator">
                        <label for="proofPrime">Test with prime p:</label>
                        <select id="proofPrime" onchange="demonstrateProofStep()">
                            <option value="3">p = 3</option>
                            <option value="5">p = 5</option>
                            <option value="7">p = 7</option>
                            <option value="11">p = 11</option>
                            <option value="13">p = 13</option>
                            <option value="17">p = 17</option>
                        </select>
                    </div>
                    <div id="proofStepResult"></div>
                </div>

                <div class="proof-step">
                    <h4>Algebraic Simplification</h4>
                    <p>First, simplify the left-hand factors:</p>
                    <div id="algebraicSteps"></div>
                </div>

                <div class="proof-step">
                    <h4>Product Extension</h4>
                    <p>Since the identity holds for each prime factor, taking the product over all primes 3 ≤ p ≤ p<sub>max</sub> preserves the equality.</p>
                </div>
            </div>
        </div>

        <div id="examples" class="tab-content">
            <h3>Detailed Numerical Examples</h3>
            
            <div class="grid">
                <div class="card">
                    <h4>Example: p<sub>max</sub> = 3</h4>
                    <div id="example3"></div>
                </div>
                
                <div class="card">
                    <h4>Example: p<sub>max</sub> = 5</h4>
                    <div id="example5"></div>
                </div>
                
                <div class="card">
                    <h4>Example: p<sub>max</sub> = 13</h4>
                    <div id="example13"></div>
                </div>
            </div>

            <div class="interactive-demo">
                <h4>Custom Example Generator</h4>
                <input type="number" id="customPmax" min="3" max="50" value="7" placeholder="Enter p_max">
                <button class="btn" onclick="generateCustomExample()">Generate Example</button>
                <div id="customExampleResult"></div>
            </div>
        </div>

        <div id="visualization" class="tab-content">
            <h3>Visual Analysis</h3>
            
            <div class="chart-container">
                <canvas id="convergenceChart"></canvas>
            </div>
            
            <div class="slider-container">
                <label for="pmaxSlider">Adjust p<sub>max</sub>: <span id="pmaxValue">13</span></label>
                <input type="range" id="pmaxSlider" class="slider" min="3" max="50" value="13" oninput="updateVisualization(this.value)">
            </div>

            <div class="grid">
                <div class="card">
                    <h4>Individual Components</h4>
                    <canvas id="componentsChart" width="300" height="200"></canvas>
                </div>
                <div class="card">
                    <h4>Factor Contributions</h4>
                    <canvas id="factorsChart" width="300" height="200"></canvas>
                </div>
            </div>
        </div>

        <div id="theory" class="tab-content">
            <h3>Mathematical Theory & Interpretation</h3>
            
            <div class="card">
                <h4>What the Identity Means</h4>
                <p>The left-hand product N(p<sub>max</sub>) represents a finite sieve factor that quantifies how many integers remain after removing residues forbidden by divisibility conditions for the twin prime pattern (n, n+2).</p>
                
                <p>The right-hand side decomposes this into:</p>
                <ul>
                    <li><strong>M<sub>≠2</sub>(p<sub>max</sub>)</strong>: Ordinary prime density factor</li>
                    <li><strong>C₂(p<sub>max</sub>)</strong>: Twin-prime specific residue correction</li>
                </ul>
            </div>

            <div class="card">
                <h4>Why the Cube Appears</h4>
                <p>The cube [M<sub>≠2</sub>(p<sub>max</sub>)]³ reflects three overlapping density factors:</p>
                <ol>
                    <li>Prime-likeness of n</li>
                    <li>Prime-likeness of n+2</li>
                    <li>Mutual compatibility of their residues</li>
                </ol>
            </div>

            <div class="card">
                <h4>Connection to Hardy-Littlewood</h4>
                <p>This identity provides an exact finite link between classical Hardy-Littlewood constants and concrete modular sieve factors used in computational approaches.</p>
            </div>

            <div class="example">
                <h4>Why Start at p = 3?</h4>
                <p>The factor for p = 2 would be (2-1)(2-2)/2² = 0, which would collapse the entire product to zero. The algebraic identity is valid only for primes p ≥ 3.</p>
            </div>
        </div>
    </div>

    <script>
        // Utility functions
        function isPrime(n) {
            if (n < 2) return false;
            if (n === 2) return true;
            if (n % 2 === 0) return false;
            for (let i = 3; i * i <= n; i += 2) {
                if (n % i === 0) return false;
            }
            return true;
        }

        function getPrimesUpTo(max) {
            const primes = [];
            for (let i = 3; i <= max; i++) {
                if (isPrime(i)) primes.push(i);
            }
            return primes;
        }

        function formatFraction(num, den) {
            const gcd = math.gcd(num, den);
            return `${num/gcd}/${den/gcd}`;
        }

        function calculateN(pmax) {
            const primes = getPrimesUpTo(pmax);
            let product = 1;
            for (const p of primes) {
                product *= (p - 1) * (p - 2) / (p * p);
            }
            return product;
        }

        function calculateC2(pmax) {
            const primes = getPrimesUpTo(pmax);
            let product = 1;
            for (const p of primes) {
                product *= (1 - 1 / ((p - 1) * (p - 1)));
            }
            return product;
        }

        function calculateMnot2(pmax) {
            const primes = getPrimesUpTo(pmax);
            let product = 1;
            for (const p of primes) {
                product *= (1 - 1 / p);
            }
            return product;
        }

        // Tab switching
        function showTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');

            // Initialize specific tab content
            if (tabName === 'examples') {
                generateExamples();
            } else if (tabName === 'visualization') {
                initializeVisualization();
            }
        }

        // Main calculator
        function calculateIdentity() {
            const pmax = parseInt(document.getElementById('pmaxInput').value);
            const primes = getPrimesUpTo(pmax);
            
            if (primes.length === 0) {
                document.getElementById('calculationResult').innerHTML = 
                    '<div class="error">No primes found in range [3, ' + pmax + ']</div>';
                return;
            }

            const N = calculateN(pmax);
            const C2 = calculateC2(pmax);
            const Mnot2 = calculateMnot2(pmax);
            const rightSide = C2 * Math.pow(Mnot2, 3);

            let html = '<div class="result">';
            html += '<h4>Results for p<sub>max</sub> = ' + pmax + '</h4>';
            html += '<p><strong>Primes used:</strong> [' + primes.join(', ') + ']</p>';
            html += '<hr style="margin: 15px 0;">';
            html += '<p><strong>N(p<sub>max</sub>)</strong> = ' + N.toFixed(10) + '</p>';
            html += '<p><strong>C₂(p<sub>max</sub>)</strong> = ' + C2.toFixed(10) + '</p>';
            html += '<p><strong>M<sub>≠2</sub>(p<sub>max</sub>)</strong> = ' + Mnot2.toFixed(10) + '</p>';
            html += '<p><strong>Right side</strong> = ' + rightSide.toFixed(10) + '</p>';
            html += '<hr style="margin: 15px 0;">';
            html += '<p><strong>Difference:</strong> ' + Math.abs(N - rightSide).toExponential(3) + '</p>';
            html += '<p><strong>Identity verified:</strong> ' + (Math.abs(N - rightSide) < 1e-12 ? '✅ TRUE' : '❌ FALSE') + '</p>';
            html += '</div>';

            document.getElementById('calculationResult').innerHTML = html;
        }

        // Proof demonstration
        function demonstrateProofStep() {
            const p = parseInt(document.getElementById('proofPrime').value);
            
            const leftFactor1 = 1 - 1/((p-1)*(p-1));
            const leftFactor2 = 1 - 1/p;
            const leftSide = leftFactor1 * Math.pow(leftFactor2, 3);
            const rightSide = (p-1)*(p-2)/(p*p);

            let html = '<div class="result">';
            html += '<h5>For p = ' + p + ':</h5>';
            html += '<p><strong>First factor:</strong> 1 - 1/(p-1)² = 1 - 1/' + (p-1) + '² = ' + leftFactor1.toFixed(6) + '</p>';
            html += '<p><strong>Second factor:</strong> (1 - 1/p)³ = (1 - 1/' + p + ')³ = ' + Math.pow(leftFactor2, 3).toFixed(6) + '</p>';
            html += '<p><strong>Left side:</strong> ' + leftSide.toFixed(10) + '</p>';
            html += '<p><strong>Right side:</strong> (p-1)(p-2)/p² = ' + (p-1) + '×' + (p-2) + '/' + p + '² = ' + rightSide.toFixed(10) + '</p>';
            html += '<p><strong>Equal?</strong> ' + (Math.abs(leftSide - rightSide) < 1e-12 ? '✅ YES' : '❌ NO') + '</p>';
            html += '</div>';

            document.getElementById('proofStepResult').innerHTML = html;

            // Show algebraic steps
            let algebraHtml = '<div class="example">';
            algebraHtml += '<h5>Algebraic manipulation for p = ' + p + ':</h5>';
            algebraHtml += '<p>1. First factor: 1 - 1/(p-1)² = ((p-1)² - 1)/(p-1)² = (p² - 2p)/(p-1)² = p(p-2)/(p-1)²</p>';
            algebraHtml += '<p>2. Second factor: (1 - 1/p)³ = ((p-1)/p)³ = (p-1)³/p³</p>';
            algebraHtml += '<p>3. Product: [p(p-2)/(p-1)²] × [(p-1)³/p³] = p(p-2)(p-1)³/[(p-1)²p³] = (p-1)(p-2)/p²</p>';
            algebraHtml += '</div>';

            document.getElementById('algebraicSteps').innerHTML = algebraHtml;
        }

        // Examples generation
        function generateExamples() {
            // Example for pmax = 3
            let html3 = '<p><strong>Primes:</strong> {3}</p>';
            html3 += '<p><strong>N(3):</strong> (3-1)(3-2)/3² = 2×1/9 = 2/9 ≈ 0.222222</p>';
            html3 += '<p><strong>C₂(3):</strong> 1-1/4 = 3/4 = 0.75</p>';
            html3 += '<p><strong>M(3):</strong> 1-1/3 = 2/3 ≈ 0.666667</p>';
            html3 += '<p><strong>Right side:</strong> (3/4) × (2/3)³ = 3/4 × 8/27 = 2/9 ✅</p>';
            document.getElementById('example3').innerHTML = html3;

            // Example for pmax = 5
            let html5 = '<p><strong>Primes:</strong> {3, 5}</p>';
            const N5 = calculateN(5);
            const C25 = calculateC2(5);
            const M5 = calculateMnot2(5);
            html5 += '<p><strong>N(5):</strong> ' + N5.toFixed(6) + '</p>';
            html5 += '<p><strong>C₂(5):</strong> ' + C25.toFixed(6) + '</p>';
            html5 += '<p><strong>M(5):</strong> ' + M5.toFixed(6) + '</p>';
            html5 += '<p><strong>Verification:</strong> ' + (Math.abs(N5 - C25 * Math.pow(M5, 3)) < 1e-12 ? '✅' : '❌') + '</p>';
            document.getElementById('example5').innerHTML = html5;

            // Example for pmax = 13
            let html13 = '<p><strong>Primes:</strong> {3, 5, 7, 11, 13}</p>';
            const N13 = calculateN(13);
            const C213 = calculateC2(13);
            const M13 = calculateMnot2(13);
            html13 += '<p><strong>N(13):</strong> ' + N13.toFixed(10) + '</p>';
            html13 += '<p><strong>C₂(13):</strong> ' + C213.toFixed(10) + '</p>';
            html13 += '<p><strong>M(13):</strong> ' + M13.toFixed(10) + '</p>';
            html13 += '<p><strong>Verification:</strong> ' + (Math.abs(N13 - C213 * Math.pow(M13, 3)) < 1e-12 ? '✅' : '❌') + '</p>';
            document.getElementById('example13').innerHTML = html13;
        }

        function generateCustomExample() {
            const pmax = parseInt(document.getElementById('customPmax').value);
            const primes = getPrimesUpTo(pmax);
            
            if (primes.length === 0) {
                document.getElementById('customExampleResult').innerHTML = 
                    '<div class="error">No primes in range [3, ' + pmax + ']</div>';
                return;
            }

            const N = calculateN(pmax);
            const C2 = calculateC2(pmax);
            const Mnot2 = calculateMnot2(pmax);

            let html = '<div class="result">';
            html += '<h5>Custom Example: p<sub>max</sub> = ' + pmax + '</h5>';
            html += '<p><strong>Primes used:</strong> {' + primes.join(', ') + '}</p>';
            html += '<p><strong>N(' + pmax + '):</strong> ' + N.toFixed(10) + '</p>';
            html += '<p><strong>C₂(' + pmax + '):</strong> ' + C2.toFixed(10) + '</p>';
            html += '<p><strong>M≠2(' + pmax + '):</strong> ' + Mnot2.toFixed(10) + '</p>';
            html += '<p><strong>Right side:</strong> ' + (C2 * Math.pow(Mnot2, 3)).toFixed(10) + '</p>';
            html += '<p><strong>Difference:</strong> ' + Math.abs(N - C2 * Math.pow(Mnot2, 3)).toExponential(3) + '</p>';
            html += '<p><strong>Identity holds:</strong> ' + (Math.abs(N - C2 * Math.pow(Mnot2, 3)) < 1e-12 ? '✅' : '❌') + '</p>';
            html += '</div>';

            document.getElementById('customExampleResult').innerHTML = html;
        }

        // Prime builder functionality
        let builderPrimes = [];
        
        function resetBuilder() {
            builderPrimes = [];
            updateBuilder();
        }

        function updateBuilder() {
            const nextPrimes = getPrimesUpTo(50).filter(p => !builderPrimes.includes(p));
            
            let html = '<div class="grid">';
            
            // Current state
            if (builderPrimes.length > 0) {
                const N = calculateNFromArray(builderPrimes);
                const C2 = calculateC2FromArray(builderPrimes);
                const M = calculateMFromArray(builderPrimes);
                
                html += '<div class="card">';
                html += '<h5>Current State</h5>';
                html += '<p><strong>Primes:</strong> [' + builderPrimes.join(', ') + ']</p>';
                html += '<p><strong>N:</strong> ' + N.toFixed(8) + '</p>';
                html += '<p><strong>C₂:</strong> ' + C2.toFixed(8) + '</p>';
                html += '<p><strong>M³:</strong> ' + Math.pow(M, 3).toFixed(8) + '</p>';
                html += '<p><strong>Equal?</strong> ' + (Math.abs(N - C2 * Math.pow(M, 3)) < 1e-12 ? '✅' : '❌') + '</p>';
                html += '</div>';
            }
            
            // Add next prime options
            html += '<div class="card">';
            html += '<h5>Add Next Prime</h5>';
            for (let i = 0; i < Math.min(5, nextPrimes.length); i++) {
                const p = nextPrimes[i];
                html += '<button class="btn" onclick="addPrimeToBuilder(' + p + ')" style="margin: 5px;">Add ' + p + '</button>';
            }
            html += '</div>';
            
            html += '</div>';
            
            document.getElementById('primeBuilder').innerHTML = html;
        }

        function addPrimeToBuilder(prime) {
            if (!builderPrimes.includes(prime)) {
                builderPrimes.push(prime);
                builderPrimes.sort((a, b) => a - b);
                updateBuilder();
            }
        }

        function calculateNFromArray(primes) {
            let product = 1;
            for (const p of primes) {
                product *= (p - 1) * (p - 2) / (p * p);
            }
            return product;
        }

        function calculateC2FromArray(primes) {
            let product = 1;
            for (const p of primes) {
                product *= (1 - 1 / ((p - 1) * (p - 1)));
            }
            return product;
        }

        function calculateMFromArray(primes) {
            let product = 1;
            for (const p of primes) {
                product *= (1 - 1 / p);
            }
            return product;
        }

        // Visualization functions
        let convergenceChart, componentsChart, factorsChart;

        function initializeVisualization() {
            createConvergenceChart();
            createComponentsChart();
            createFactorsChart();
        }

        function createConvergenceChart() {
            const ctx = document.getElementById('convergenceChart');
            if (!ctx) return;

            const data = [];
            const labels = [];
            const nData = [];
            const rightData = [];

            for (let pmax = 3; pmax <= 50; pmax++) {
                if (getPrimesUpTo(pmax).length > 0) {
                    const N = calculateN(pmax);
                    const C2 = calculateC2(pmax);
                    const M = calculateMnot2(pmax);
                    const rightSide = C2 * Math.pow(M, 3);
                    
                    labels.push(pmax);
                    nData.push(N);
                    rightData.push(rightSide);
                }
            }

            if (convergenceChart) {
                convergenceChart.destroy();
            }

            convergenceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'N(p_max) - Left Side',
                        data: nData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: false
                    }, {
                        label: 'C₂ × M³ - Right Side',
                        data: rightData,
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Identity Convergence as p_max Increases'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'p_max'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    }
                }
            });
        }

        function createComponentsChart() {
            const ctx = document.getElementById('componentsChart');
            if (!ctx) return;

            const pmax = 13;
            const N = calculateN(pmax);
            const C2 = calculateC2(pmax);
            const M = calculateMnot2(pmax);
            const M3 = Math.pow(M, 3);

            if (componentsChart) {
                componentsChart.destroy();
            }

            componentsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['N(p_max)', 'C₂(p_max)', 'M(p_max)', 'M³(p_max)'],
                    datasets: [{
                        label: 'Component Values',
                        data: [N, C2, M, M3],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(46, 204, 113, 0.8)',
                            'rgba(231, 76, 60, 0.8)'
                        ],
                        borderColor: [
                            '#667eea',
                            '#764ba2',
                            '#2ecc71',
                            '#e74c3c'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Individual Component Values (p_max = 13)'
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    }
                }
            });
        }

        function createFactorsChart() {
            const ctx = document.getElementById('factorsChart');
            if (!ctx) return;

            const primes = getPrimesUpTo(13);
            const labels = primes.map(p => `p=${p}`);
            const leftFactors = primes.map(p => (p-1)*(p-2)/(p*p));
            const rightFactors = primes.map(p => (1 - 1/((p-1)*(p-1))) * Math.pow(1 - 1/p, 3));

            if (factorsChart) {
                factorsChart.destroy();
            }

            factorsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Left Factor',
                        data: leftFactors,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2
                    }, {
                        label: 'Right Factor',
                        data: rightFactors,
                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                        borderColor: '#764ba2',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Per-Prime Factor Comparison'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Factor Value'
                            }
                        }
                    }
                }
            });
        }

        function updateVisualization(value) {
            document.getElementById('pmaxValue').textContent = value;
            createComponentsChart();
        }

        function showAllSteps() {
            const pmax = parseInt(document.getElementById('pmaxInput').value);
            const primes = getPrimesUpTo(pmax);
            
            let html = '<div class="result">';
            html += '<h4>Detailed Step-by-Step Calculation for p<sub>max</sub> = ' + pmax + '</h4>';
            html += '<p><strong>Primes used:</strong> [' + primes.join(', ') + ']</p>';
            html += '<hr>';
            
            // Left side calculation
            html += '<h5>Left Side: N(p<sub>max</sub>)</h5>';
            let leftProduct = 1;
            for (let i = 0; i < primes.length; i++) {
                const p = primes[i];
                const factor = (p-1)*(p-2)/(p*p);
                leftProduct *= factor;
                html += '<p>Step ' + (i+1) + ': p=' + p + ' → factor = (' + (p-1) + ')×(' + (p-2) + ')/' + p + '² = ' + factor.toFixed(6);
                html += ' → running product = ' + leftProduct.toFixed(8) + '</p>';
            }
            
            html += '<hr>';
            
            // Right side calculation
            html += '<h5>Right Side: C₂(p<sub>max</sub>) × [M<sub>≠2</sub>(p<sub>max</sub>)]³</h5>';
            
            // C2 calculation
            html += '<h6>C₂ calculation:</h6>';
            let c2Product = 1;
            for (let i = 0; i < primes.length; i++) {
                const p = primes[i];
                const factor = 1 - 1/((p-1)*(p-1));
                c2Product *= factor;
                html += '<p>p=' + p + ' → 1-1/(' + (p-1) + ')² = ' + factor.toFixed(6);
                html += ' → running C₂ = ' + c2Product.toFixed(8) + '</p>';
            }
            
            // M calculation
            html += '<h6>M<sub>≠2</sub> calculation:</h6>';
            let mProduct = 1;
            for (let i = 0; i < primes.length; i++) {
                const p = primes[i];
                const factor = 1 - 1/p;
                mProduct *= factor;
                html += '<p>p=' + p + ' → 1-1/' + p + ' = ' + factor.toFixed(6);
                html += ' → running M = ' + mProduct.toFixed(8) + '</p>';
            }
            
            const mCubed = Math.pow(mProduct, 3);
            const rightSide = c2Product * mCubed;
            
            html += '<h6>Final right side calculation:</h6>';
            html += '<p>M³ = (' + mProduct.toFixed(8) + ')³ = ' + mCubed.toFixed(10) + '</p>';
            html += '<p>C₂ × M³ = ' + c2Product.toFixed(8) + ' × ' + mCubed.toFixed(10) + ' = ' + rightSide.toFixed(10) + '</p>';
            
            html += '<hr>';
            html += '<h5>Verification:</h5>';
            html += '<p><strong>Left side:</strong> ' + leftProduct.toFixed(10) + '</p>';
            html += '<p><strong>Right side:</strong> ' + rightSide.toFixed(10) + '</p>';
            html += '<p><strong>Difference:</strong> ' + Math.abs(leftProduct - rightSide).toExponential(3) + '</p>';
            html += '<p><strong>Identity verified:</strong> ' + (Math.abs(leftProduct - rightSide) < 1e-12 ? '✅ EXACT MATCH' : '❌ MISMATCH') + '</p>';
            
            html += '</div>';
            
            document.getElementById('calculationResult').innerHTML = html;
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            calculateIdentity();
            updateBuilder();
            demonstrateProofStep();
            generateExamples();
            
            // Initialize visualization after a short delay to ensure DOM is ready
            setTimeout(initializeVisualization, 100);
        });
    </script>
</body>
    </html>
